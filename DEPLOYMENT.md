# üöÄ Deployment Checklist

Complete guide for deploying Konfirmado to production on Vercel.

## ‚úÖ Pre-Deployment Checklist

### 1. Environment Variables

Ensure all required environment variables are set:

#### Required (Core Functionality)
- [ ] `DATABASE_URL` - PostgreSQL connection string
- [ ] `NEXTAUTH_URL` - Production URL (e.g., `https://konfirmado.com`)
- [ ] `NEXTAUTH_SECRET` - Generated with `openssl rand -base64 32`
- [ ] `ENCRYPTION_KEY` - 32 random characters
- [ ] `GOOGLE_CLIENT_ID` - From Google Cloud Console
- [ ] `GOOGLE_CLIENT_SECRET` - From Google Cloud Console
- [ ] `NEXT_PUBLIC_APP_URL` - Production URL (e.g., `https://konfirmado.com`)
- [ ] `CALLBACK_SECRET` - Generated with `openssl rand -base64 32`

#### Optional (Enhanced Features)
- [ ] `RESEND_API_KEY` - For email notifications
- [ ] `RESEND_FROM_EMAIL` - Verified sender email
- [ ] `CRON_SECRET` - For cron job authentication
- [ ] `BLOB_READ_WRITE_TOKEN` - Auto-generated by Vercel Blob

### 2. External Services

- [ ] **PostgreSQL Database** - Configured and accessible
- [ ] **Google Cloud Project** - Calendar API enabled
- [ ] **Resend Account** - (Optional) For emails
- [ ] **Vercel Blob** - (Optional) For file uploads

### 3. Code Preparation

- [ ] All tests passing
- [ ] No console errors in development
- [ ] Build succeeds locally (`pnpm build`)
- [ ] Database schema is up to date

---

## üì¶ Vercel Deployment Steps

### Step 1: Install Vercel CLI

```bash
pnpm i -g vercel
```

### Step 2: Login to Vercel

```bash
vercel login
```

### Step 3: Link Project

```bash
vercel link
```

Follow prompts to:
- Select or create a team
- Link to existing project or create new
- Link to current directory

### Step 4: Configure Environment Variables

**Option A: Via Vercel Dashboard**
1. Go to [vercel.com](https://vercel.com)
2. Select your project
3. Go to **Settings** ‚Üí **Environment Variables**
4. Add all required variables
5. Select environments: Production, Preview, Development

**Option B: Via CLI**

```bash
# Set production variables
vercel env add NEXTAUTH_SECRET production
vercel env add DATABASE_URL production
# ... repeat for all variables
```

### Step 5: Setup PostgreSQL Database

**Recommended: Vercel Postgres**

1. Go to Vercel Dashboard ‚Üí **Storage**
2. Click **Create Database** ‚Üí **Postgres**
3. Click **Connect** to link to your project
4. Environment variable `DATABASE_URL` is added automatically

**Alternative: External PostgreSQL**
- Neon
- Supabase
- Railway
- Your own server

### Step 6: Setup Vercel Blob (Optional)

1. Go to Vercel Dashboard ‚Üí **Storage**
2. Click **Create Database** ‚Üí **Blob**
3. Click **Connect**
4. `BLOB_READ_WRITE_TOKEN` added automatically

### Step 7: Deploy

```bash
# Deploy to production
vercel --prod
```

### Step 8: Run Database Migrations

The `vercel-build` script automatically runs:
```bash
prisma generate && prisma db push --accept-data-loss && next build
```

### Step 9: Configure Cron Jobs

Create `vercel.json` in project root:

```json
{
  "crons": [{
    "path": "/api/cron/cleanup-holds",
    "schedule": "*/5 * * * *"
  }]
}

```

Commit and redeploy:
```bash
git add vercel.json
git commit -m "Add cron jobs"
git push
vercel --prod
```

---

## üîß Post-Deployment Configuration

### 1. Update Google OAuth Redirect URIs

1. Go to [Google Cloud Console](https://console.cloud.google.com)
2. Navigate to **APIs & Services** ‚Üí **Credentials**
3. Edit your OAuth 2.0 Client
4. Add production redirect URI:
   ```
   https://your-domain.com/api/calendar/callback
   ```

### 2. Configure Wompi Webhooks

For each tenant using Wompi:
1. Go to Wompi Dashboard
2. Navigate to **Developers** ‚Üí **Webhooks**
3. Add webhook URL:
   ```
   https://your-domain.com/api/webhooks/wompi
   ```

### 3. Verify Email Domain (Optional)

If using Resend:
1. Go to [Resend Dashboard](https://resend.com)
2. Navigate to **Domains**
3. Add your domain
4. Add DNS records as instructed
5. Verify domain

### 4. Test Core Functionality

- [ ] User registration works
- [ ] Email verification works
- [ ] Login works
- [ ] Calendar connection works
- [ ] Booking creation works
- [ ] Payment processing works
- [ ] Email notifications work
- [ ] File uploads work

---

## üîÑ Continuous Deployment

### Setup Git Integration

1. Go to Vercel Dashboard ‚Üí **Settings** ‚Üí **Git**
2. Connect your GitHub/GitLab/Bitbucket repository
3. Configure:
   - **Production Branch:** `main` or `master`
   - **Preview Branches:** All branches
   - **Auto-deploy:** Enabled

### Deployment Workflow

```
Developer pushes to branch
    ‚Üì
Vercel creates preview deployment
    ‚Üì
Review and test
    ‚Üì
Merge to main
    ‚Üì
Automatic production deployment
```

---

## üìä Monitoring

### Vercel Analytics

Enable in dashboard:
1. Go to **Analytics** tab
2. Enable **Web Analytics**
3. Enable **Speed Insights**

### Error Tracking

Check deployment logs:
```bash
vercel logs <deployment-url>
```

Or in dashboard:
- **Deployments** ‚Üí Select deployment ‚Üí **Logs**

### Performance Monitoring

- **Runtime Logs** - Check for errors
- **Function Logs** - API route performance
- **Build Logs** - Build-time issues

---

## üêõ Troubleshooting

### Build Fails

**Check:**
- [ ] All dependencies installed
- [ ] TypeScript errors resolved
- [ ] Environment variables set
- [ ] Database accessible

**View logs:**
```bash
vercel logs <deployment-url> --follow
```

### Database Connection Issues

**Check:**
- [ ] `DATABASE_URL` is correct
- [ ] Database allows connections from Vercel IPs
- [ ] SSL mode is configured correctly

**Test connection:**
```bash
vercel env pull .env.production
# Test locally with production env
```

### OAuth Errors

**Check:**
- [ ] Redirect URIs match exactly
- [ ] `NEXTAUTH_URL` is correct
- [ ] `NEXTAUTH_SECRET` is set
- [ ] Cookies are enabled

### Email Not Sending

**Check:**
- [ ] `RESEND_API_KEY` is set
- [ ] Domain is verified
- [ ] `RESEND_FROM_EMAIL` uses verified domain

### File Upload Fails

**Check:**
- [ ] Vercel Blob is connected
- [ ] `BLOB_READ_WRITE_TOKEN` is set
- [ ] User is authenticated

---

## üîê Security Checklist

- [ ] All secrets use strong random values
- [ ] HTTPS enforced (automatic on Vercel)
- [ ] Environment variables not exposed to client
- [ ] Database credentials secured
- [ ] API routes have authentication
- [ ] CORS configured correctly
- [ ] Rate limiting enabled (if using Upstash)

---

## üìà Scaling Considerations

### Database

- Monitor connection pool usage
- Consider read replicas for high traffic
- Enable connection pooling (PgBouncer)

### File Storage

- Monitor Vercel Blob usage
- Consider CDN for static assets
- Implement image optimization

### Serverless Functions

- Monitor function execution time
- Optimize cold starts
- Consider edge functions for global performance

---

## üéâ Launch Checklist

Final checks before going live:

- [ ] All environment variables configured
- [ ] Database migrations applied
- [ ] External services configured
- [ ] DNS records updated
- [ ] SSL certificate active
- [ ] Monitoring enabled
- [ ] Backup strategy in place
- [ ] Support email configured
- [ ] Terms & Privacy policy published
- [ ] First tenant account created
- [ ] Test booking completed end-to-end

---

## üìû Support Resources

- **Vercel Docs:** https://vercel.com/docs
- **Vercel Support:** https://vercel.com/support
- **Prisma Docs:** https://www.prisma.io/docs
- **Next.js Docs:** https://nextjs.org/docs

---

**Ready to deploy! üöÄ**
